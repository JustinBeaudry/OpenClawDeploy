<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .input-field { @apply w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:outline-none focus:border-blue-500 transition-colors; }
        .btn-primary { @apply bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-2 px-4 rounded shadow-lg shadow-blue-900/20 transition-all transform hover:scale-[1.02]; }
        .btn-secondary { @apply bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-medium py-2 px-4 rounded transition-all; }
        .btn-danger { @apply bg-red-900/20 hover:bg-red-900/40 border border-red-900 text-red-400 font-medium py-2 px-4 rounded transition-all; }
        .card { @apply bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 shadow-xl transition-all hover:border-slate-700; }
        .glass-panel { @apply bg-slate-900/80 backdrop-blur border border-slate-800 rounded-xl shadow-2xl; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (SVGs) ---
        const Icons = {
            Server: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01"></path></svg>,
            Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>,
            Cpu: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>,
            Terminal: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>,
            Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>,
            ArrowLeft: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path></svg>,
            Save: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
        };

        // --- Helper Components ---

        const MetricsCard = ({ label, value, subtext, icon: Icon, color = "blue" }) => (
            <div className={`p-4 bg-slate-800/50 rounded-lg border border-slate-700 relative overflow-hidden group`}>
                <div className={`absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity text-${color}-400`}>
                    <Icon />
                </div>
                <label className="text-xs text-slate-500 uppercase font-bold tracking-wider">{label}</label>
                <p className="text-xl text-white mt-1 font-mono">{value}</p>
                {subtext && <p className={`text-xs mt-1 text-${color}-400`}>{subtext}</p>}
            </div>
        );

        const Toggle = ({ enabled, onChange }) => (
            <button 
                onClick={() => onChange(!enabled)}
                className={`w-12 h-6 rounded-full p-1 transition-colors ${enabled ? 'bg-green-500' : 'bg-slate-700'}`}
            >
                <div className={`w-4 h-4 rounded-full bg-white shadow-md transform transition-transform ${enabled ? 'translate-x-6' : 'translate-x-0'}`} />
            </button>
        );

        const ConfigEditor = ({ config, onSave }) => {
            const [localConfig, setLocalConfig] = useState(config?.clawdbot || {});
            const [dirty, setDirty] = useState(false);

            useEffect(() => {
                setLocalConfig(config || {});
            }, [config]);

            const update = (path, value) => {
                const newConfig = { ...localConfig };
                const parts = path.split('.');
                
                // Deep set helper
                let current = newConfig;
                for (let i = 0; i < parts.length - 1; i++) {
                    current[parts[i]] = current[parts[i]] || {};
                    current = current[parts[i]];
                }
                current[parts[parts.length - 1]] = value;
                
                setLocalConfig(newConfig);
                setDirty(true);
            };

            const handleSave = () => {
                onSave(localConfig);
                setDirty(false);
            };

            return (
                <div className="space-y-8 animate-fade-in">
                    
                    {/* Header Action */}
                    <div className="flex justify-end sticky top-0 bg-slate-900/90 backdrop-blur-md py-4 z-20 border-b border-slate-800 -mx-6 px-6 -mt-6">
                        <button 
                            onClick={handleSave} 
                            disabled={!dirty}
                            className={`btn-primary flex items-center gap-2 ${!dirty ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}
                        >
                            <Icons.Save /> Save Configuration
                        </button>
                    </div>

                    {/* 1. Identity */}
                    <section className="space-y-4">
                        <h3 className="text-lg font-bold text-blue-400 border-b border-blue-500/20 pb-2">Bot Identity</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Bot Name</label>
                                <input 
                                    className="input-field" 
                                    value={localConfig.ui?.assistant?.name || ''} 
                                    onChange={e => update('ui.assistant.name', e.target.value)}
                                    placeholder="Clawd"
                                />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Avatar URL</label>
                                <input 
                                    className="input-field" 
                                    value={localConfig.ui?.assistant?.avatar || ''} 
                                    onChange={e => update('ui.assistant.avatar', e.target.value)}
                                    placeholder="https://..."
                                />
                            </div>
                        </div>
                    </section>

                    {/* 2. Plugins */}
                    <section className="space-y-4">
                        <h3 className="text-lg font-bold text-purple-400 border-b border-purple-500/20 pb-2">Active Plugins</h3>
                        <div className="grid grid-cols-1 gap-4">
                            {['slack', 'discord', 'signal', 'google-gemini-cli-auth'].map(plugin => {
                                const enabled = localConfig.plugins?.entries?.[plugin]?.enabled ?? false;
                                return (
                                    <div key={plugin} className="flex items-center justify-between p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                        <div className="flex flex-col">
                                            <span className="font-bold text-white capitalize">{plugin.replace(/-/g, ' ')}</span>
                                            <span className="text-xs text-slate-500 font-mono">plugins.entries.{plugin}</span>
                                        </div>
                                        <Toggle enabled={enabled} onChange={val => update(`plugins.entries.${plugin}.enabled`, val)} />
                                    </div>
                                );
                            })}
                        </div>
                    </section>

                    {/* 3. API Keys (Secrets) */}
                    <section className="space-y-4">
                        <h3 className="text-lg font-bold text-green-400 border-b border-green-500/20 pb-2">API Keys & Secrets</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">OpenAI / DeepInfra Key</label>
                                <input 
                                    className="input-field font-mono text-sm" 
                                    type="password"
                                    value={localConfig.models?.providers?.deepinfra?.apiKey || ''} 
                                    onChange={e => update('models.providers.deepinfra.apiKey', e.target.value)}
                                    placeholder="sk-..."
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Google Client ID</label>
                                    <input 
                                        className="input-field font-mono text-sm" 
                                        value={localConfig.env?.vars?.GOOGLE_CLIENT_ID || ''} 
                                        onChange={e => update('env.vars.GOOGLE_CLIENT_ID', e.target.value)}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Google Client Secret</label>
                                    <input 
                                        className="input-field font-mono text-sm" 
                                        type="password"
                                        value={localConfig.env?.vars?.GOOGLE_CLIENT_SECRET || ''} 
                                        onChange={e => update('env.vars.GOOGLE_CLIENT_SECRET', e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* 4. Raw JSON Fallback */}
                    <section className="space-y-4 pt-8">
                        <details className="group">
                            <summary className="cursor-pointer text-slate-500 hover:text-slate-300 font-medium select-none flex items-center gap-2">
                                <Icons.Terminal /> Advanced: Edit Raw JSON
                            </summary>
                            <div className="mt-4">
                                <textarea 
                                    className="w-full h-96 bg-slate-950 text-green-400 font-mono text-xs p-4 rounded border border-slate-800 focus:outline-none focus:border-green-500"
                                    value={JSON.stringify(localConfig, null, 2)}
                                    onChange={e => {
                                        try {
                                            setLocalConfig(JSON.parse(e.target.value));
                                            setDirty(true);
                                        } catch (err) {} // Ignore parse errors while typing
                                    }}
                                />
                            </div>
                        </details>
                    </section>
                </div>
            );
        };

        const DeploymentProgress = ({ logs }) => {
            const [status, setStatus] = useState({ step: 0, label: 'Idle' });
            
            // Steps Definition
            const STEPS = [
                { id: 1, label: 'Initialize', match: /Creating VM/ },
                { id: 2, label: 'Provision VM', match: /VM Created/ },
                { id: 3, label: 'SSH Setup', match: /Updating local SSH/ },
                { id: 4, label: 'Install Software', match: /Running Playbook/ },
                { id: 5, label: 'Configure', match: /Enforce secure gateway/ },
                { id: 6, label: 'Complete', match: /PROCESS FINISHED/ }
            ];

            useEffect(() => {
                const text = logs.join('\n');
                let maxStep = 0;
                let currentLabel = 'Idle';

                STEPS.forEach((step, idx) => {
                    if (step.match.test(text)) {
                        maxStep = step.id;
                        currentLabel = step.label;
                    }
                });
                
                // If complete, force max
                if (text.includes('PROCESS FINISHED')) maxStep = STEPS.length;

                setStatus({ step: maxStep, label: currentLabel });
            }, [logs]);

            if (status.step === 0) return null;

            return (
                <div className="mb-6">
                    <div className="flex justify-between text-xs text-slate-400 mb-2 font-bold uppercase tracking-wider">
                        <span>Deployment Progress</span>
                        <span className={status.step === STEPS.length ? "text-green-400" : "text-blue-400"}>
                            {status.step === STEPS.length ? 'Success' : status.label}...
                        </span>
                    </div>
                    <div className="h-2 bg-slate-800 rounded-full overflow-hidden flex">
                        {STEPS.map((s, i) => (
                            <div 
                                key={s.id}
                                className={`h-full flex-1 border-r border-slate-900 transition-all duration-500 ${ 
                                    status.step >= s.id ? 'bg-green-500' : 'bg-transparent'
                                } ${status.step === s.id && status.step !== STEPS.length ? 'animate-pulse bg-blue-500' : ''}`}
                            />
                        ))}
                    </div>
                    <div className="flex justify-between mt-2">
                        {STEPS.map((s) => (
                            <div key={s.id} className={`text-[10px] ${status.step >= s.id ? 'text-slate-300' : 'text-slate-700'}`}>
                                {s.label}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const LogTerminal = ({ logs, clearLogs }) => {
            const bottomRef = useRef(null);
            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [logs]);

            if (logs.length === 0) return null;

            return (
                <div className="mt-4 border-t border-slate-700 pt-4">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="text-xs font-bold uppercase tracking-wider text-slate-500 flex items-center gap-2">
                            <Icons.Terminal /> Console Output
                        </h3>
                        <button onClick={clearLogs} className="text-xs text-slate-600 hover:text-slate-400">Clear</button>
                    </div>
                    <div className="bg-black text-green-400 p-4 rounded-lg font-mono text-xs h-48 overflow-y-auto whitespace-pre-wrap border border-slate-800 shadow-inner">
                        {logs.join('')}
                        <div ref={bottomRef} />
                    </div>
                </div>
            );
        };

        // --- Instance Details View ---
        const InstanceDetails = ({ instance, onBack, onUpdate, onSaveConfig, logs, clearLogs }) => {
            const [activeTab, setActiveTab] = useState('overview');
            const [config, setConfig] = useState(instance.config || {});
            const [metrics, setMetrics] = useState(null);
            const [metricsLoading, setMetricsLoading] = useState(false);
            const [fullConfig, setFullConfig] = useState(null);

            useEffect(() => {
                // Fetch config template
                fetch(`/api/template`).then(r => r.json()).then(setFullConfig);
                
                // Initial Metrics Load
                loadMetrics();
                
                // Poll metrics every 30s
                const interval = setInterval(loadMetrics, 30000);
                return () => clearInterval(interval);
            }, [instance]);

            const loadMetrics = () => {
                if (!instance.project_id || !instance.zone) return;
                setMetricsLoading(true);
                fetch(`/api/gcp/metrics/${instance.name}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project: instance.project_id, zone: instance.zone })
                })
                .then(r => r.json())
                .then(setMetrics)
                .catch(() => setMetrics(null))
                .finally(() => setMetricsLoading(false));
            };

            const tabs = [
                { id: 'overview', label: 'Overview', icon: Icons.Server },
                { id: 'config', label: 'Configuration', icon: Icons.Settings },
                { id: 'security', label: 'Security', icon: Icons.Shield },
                { id: 'logs', label: 'Logs & Operations', icon: Icons.Terminal },
            ];

            return (
                <div className="container mx-auto p-6 max-w-6xl animate-fade-in">
                    {/* Header */}
                    <div className="flex items-center gap-4 mb-8">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-800 text-slate-400 hover:text-white transition">
                            <Icons.ArrowLeft />
                        </button>
                        <div>
                            <h1 className="text-3xl font-bold text-white">{instance.name}</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <span className={`w-2 h-2 rounded-full shadow-[0_0_10px] ${metrics?.status === 'RUNNING' ? 'bg-green-500 shadow-green-500/50' : 'bg-slate-500'}`}></span>
                                <span className={`text-sm font-medium ${metrics?.status === 'RUNNING' ? 'text-green-400' : 'text-slate-400'}`}>
                                    {metrics?.status || 'UNKNOWN'}
                                </span>
                                <span className="text-slate-600 mx-2">‚Ä¢</span>
                                <span className="text-sm text-slate-400">{instance.project_id}</span>
                                <span className="text-slate-600 mx-2">‚Ä¢</span>
                                <span className="text-sm text-slate-400">{instance.zone}</span>
                            </div>
                        </div>
                        <div className="ml-auto flex gap-3">
                            <button onClick={() => { setActiveTab('logs'); onUpdate('update'); }} className="btn-primary flex items-center gap-2">
                                <Icons.Cpu /> Apply Updates
                            </button>
                        </div>
                    </div>

                    <div className="flex gap-8">
                        {/* Sidebar Tabs */}
                        <div className="w-64 flex-shrink-0 space-y-2">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${ 
                                        activeTab === tab.id 
                                            ? 'bg-blue-600/10 text-blue-400 border border-blue-600/20' 
                                            : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'
                                    }`}
                                >
                                    <tab.icon />
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 min-w-0">
                            <div className="glass-panel p-6 min-h-[500px]">
                                
                                {activeTab === 'overview' && (
                                    <div className="space-y-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-xl font-bold text-white">Live Metrics</h2>
                                            <button onClick={loadMetrics} className={`text-xs text-blue-400 hover:text-blue-300 ${metricsLoading ? 'animate-spin' : ''}`}>
                                                ‚Üª Refresh
                                            </button>
                                        </div>
                                        
                                        {!metrics ? (
                                            <div className="p-8 text-center text-slate-500 italic border border-dashed border-slate-800 rounded-lg">
                                                {metricsLoading ? 'Fetching metrics...' : 'Unable to load instance metrics.'}
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-2 gap-6">
                                                <MetricsCard 
                                                    label="Status" 
                                                    value={metrics.status} 
                                                    subtext={`Uptime: ${metrics.uptime}`}
                                                    icon={Icons.Server}
                                                    color={metrics.status === 'RUNNING' ? 'green' : 'slate'}
                                                />
                                                <p className="text-lg text-white mt-1">t2a-standard-2 (ARM)</p>
                                                <MetricsCard 
                                                    label="Network (Tailscale)" 
                                                    value="100.x.y.z" 
                                                    subtext="Accessible via VPN only"
                                                    icon={Icons.Shield}
                                                    color="green"
                                                />
                                                <MetricsCard 
                                                    label="Public IP" 
                                                    value={metrics.publicIp} 
                                                    subtext="Firewalled (Blocked)"
                                                    icon={() => <span className="text-xl">üåê</span>}
                                                    color="red"
                                                />
                                            </div>
                                        )}

                                        <div className="mt-8 p-4 bg-blue-900/10 border border-blue-500/20 rounded-lg">
                                            <h3 className="text-sm font-bold text-blue-300 mb-2">Connect to your Bot</h3>
                                            <div className="flex items-center gap-4">
                                                <div className="flex-1 bg-black/50 p-2 rounded border border-slate-700 font-mono text-xs text-slate-300">
                                                    http://{instance.name}:18789
                                                </div>
                                                <a 
                                                    href={`http://${instance.name}:18789`}
                                                    target="_blank" 
                                                    className="btn-secondary text-xs"
                                                >
                                                    Open Dashboard ‚Üó
                                                </a>
                                            </div>
                                            <p className="text-[10px] text-slate-500 mt-2">
                                                Requires Tailscale connection. Use the Tailscale IP or MagicDNS name.
                                            </p>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'config' && (
                                    <ConfigEditor 
                                        config={fullConfig} 
                                        onSave={(newConfig) => onSaveConfig(instance.name, newConfig)} 
                                    />
                                )}

                                {activeTab === 'security' && (
                                    <div className="space-y-6">
                                        <h2 className="text-xl font-bold text-white">Security & Access</h2>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Tailscale Auth Key</label>
                                                <div className="flex gap-2">
                                                    <input 
                                                        className="input-field font-mono text-sm" 
                                                        value={instance.tailscale_key || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                                                        readOnly 
                                                        type="password"
                                                    />
                                                    <button className="btn-secondary">Update</button>
                                                </div>
                                                <p className="text-xs text-slate-500 mt-2">
                                                    Updating this key will re-authenticate the bot on the next deployment run.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'logs' && (
                                    <div className="h-full flex flex-col">
                                        <h2 className="text-xl font-bold text-white mb-4">Live Operations</h2>
                                        
                                        <DeploymentProgress logs={logs} />
                                        
                                        <div className="flex-1 bg-black rounded-lg border border-slate-800 p-4 overflow-hidden flex flex-col">
                                            <div className="flex-1 overflow-y-auto font-mono text-xs text-green-400 whitespace-pre-wrap">
                                                {logs.length > 0 ? logs.join('') : <span className="text-slate-600">Waiting for logs...</span>}
                                            </div>
                                        </div>
                                        <div className="mt-4 flex gap-2">
                                            <button onClick={clearLogs} className="btn-secondary text-xs">Clear Output</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('list'); // list, wizard, instance
            const [deployments, setDeployments] = useState([]);
            const [logs, setLogs] = useState([]);
            const [selectedInstance, setSelectedInstance] = useState(null);
            
            // Wizard State
            const [step, setStep] = useState(1);
            const [wizName, setWizName] = useState('');
            const [wizProject, setWizProject] = useState('');
            const [wizZone, setWizZone] = useState('us-central1-a'); // Default fallback
            const [wizTailscale, setWizTailscale] = useState('');
            const [wizConfig, setWizConfig] = useState(null);
            
            // GCP State
            const [gcpAuth, setGcpAuth] = useState(null);
            const [projects, setProjects] = useState([]);
            const [projectMode, setProjectMode] = useState('select'); // 'select', 'create'
            const [newProjectId, setNewProjectId] = useState('');
            const [createLoading, setCreateLoading] = useState(false);
            const [apiStatus, setApiStatus] = useState(null);
            
            // OAuth State
            const [clientId, setClientId] = useState('');
            const [clientSecret, setClientSecret] = useState('');

            // Zone Heuristics
            const detectOptimalZone = () => {
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                if (tz.startsWith('Europe/')) return 'europe-west1-b'; // Belgium
                if (tz.startsWith('Asia/')) return 'asia-northeast1-a'; // Tokyo
                if (tz.startsWith('Australia/')) return 'australia-southeast1-a'; // Sydney
                
                if (tz.startsWith('America/')) {
                    if (tz.includes('New_York') || tz.includes('Toronto') || tz.includes('Detroit')) return 'us-east4-a'; // N. Virginia
                    if (tz.includes('Chicago') || tz.includes('Mexico_City')) return 'us-central1-a'; // Iowa
                    if (tz.includes('Denver') || tz.includes('Phoenix')) return 'us-west4-a'; // Las Vegas
                    if (tz.includes('Los_Angeles') || tz.includes('Vancouver')) return 'us-west1-a'; // Oregon
                    return 'us-east1-b'; // S. Carolina (Safe East default)
                }
                
                return 'us-central1-a'; // Ultimate fallback
            };

            useEffect(() => {
                fetch('/api/deployments').then(r => r.json()).then(setDeployments);
                fetch('/api/template').then(r => r.json()).then(setWizConfig);
                checkGcp();
                
                setWizZone(detectOptimalZone());
                
                const ws = new WebSocket(`ws://${window.location.host}`);
                ws.onmessage = (event) => {
                    setLogs(prev => [...prev, event.data]);
                };
            }, []);

            useEffect(() => {
                if (wizProject) checkApis();
                else setApiStatus(null);
            }, [wizProject]);

            const checkGcp = () => {
                fetch('/api/gcp/auth').then(r => r.json()).then(setGcpAuth);
                fetch('/api/gcp/projects').then(r => r.json()).then(setProjects);
            };

            const checkApis = () => {
                setApiStatus('loading');
                fetch(`/api/gcp/services?projectId=${wizProject}`)
                    .then(r => r.json())
                    .then(setApiStatus);
            };

            const createProject = async () => {
                if (!newProjectId) return;
                setCreateLoading(true);
                try {
                    const res = await fetch('/api/gcp/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectId: newProjectId })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        alert(`Project ${newProjectId} created! Select it from the list.`);
                        setNewProjectId('');
                        setProjectMode('select');
                        checkGcp(); // Refresh list
                    } else {
                        alert(`Error: ${data.error}\n\nTip: You might need to create it manually in the console if you don't have Organization permissions.`);
                    }
                } catch (e) {
                    alert('Failed to create project.');
                } finally {
                    setCreateLoading(false);
                }
            };

            const enableApis = async () => {
                if (!wizProject) return alert('Select a project first');
                await fetch('/api/gcp/services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId: wizProject })
                });
                setTimeout(checkApis, 5000); 
                setTimeout(checkApis, 15000); 
            };

            const startWizard = () => {
                setWizName('');
                setStep(1);
                setWizZone(detectOptimalZone());
                setView('wizard');
            };

            const nextStep = () => setStep(s => s + 1);
            const prevStep = () => setStep(s => s - 1);

            const deploy = async (action, instanceName, configOverride) => {
                const targetName = instanceName || wizName;
                
                // If deploying via Wizard, use wizard state
                // If updating via Instance View, use current config
                let body = {};
                
                if (instanceName) {
                    // Update existing
                    body = { 
                        action: action,
                        gcpProject: configOverride?.project_id,
                        gcpZone: configOverride?.zone
                    };
                } else {
                    // New Create
                    const finalConfig = { ...wizConfig };
                    if (clientId) {
                        finalConfig.env.vars.GOOGLE_CLIENT_ID = clientId;
                        finalConfig.env.vars.GOOGLE_CLIENT_SECRET = clientSecret;
                    }
                    
                    // Save config first
                    await fetch(`/api/deployments/${targetName}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tailscaleKey: wizTailscale,
                            gcpProject: wizProject,
                            gcpZone: wizZone,
                            openclawConfig: finalConfig
                        })
                    });
                    
                    body = { 
                        action: action,
                        gcpProject: wizProject,
                        gcpZone: wizZone
                    };
                }

                // Trigger Script
                await fetch(`/api/deploy/${targetName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            };

            // Render Helpers
            const LogTerminal = ({ logs, clearLogs }) => {
                const bottomRef = useRef(null);
                useEffect(() => {
                    bottomRef.current?.scrollIntoView({ behavior: "smooth" });
                }, [logs]);

                if (logs.length === 0) return null;

                return (
                    <div className="mt-8 border-t border-slate-700 pt-4">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold uppercase tracking-wider text-slate-500">Console Output</h3>
                            <button onClick={clearLogs} className="text-xs text-slate-600 hover:text-slate-400">Clear</button>
                        </div>
                        <div className="bg-black text-green-400 p-3 rounded font-mono text-xs h-32 overflow-y-auto whitespace-pre-wrap border border-slate-800">
                            {logs.join('')}
                            <div ref={bottomRef} />
                        </div>
                    </div>
                );
            };

            const ApiStatusBadge = ({ name, enabled }) => (
                <div className={`flex items-center gap-2 text-xs py-1 px-2 rounded border ${enabled ? 'bg-emerald-900/20 border-emerald-500/30 text-emerald-300' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>
                    <span className={enabled ? "text-emerald-400" : "text-slate-500"}>{enabled ? '‚úÖ' : '‚óã'}</span>
                    <span className="font-mono">{name.split('.')[0]}</span>
                </div>
            );

            if (view === 'instance') {
                return (
                    <InstanceDetails 
                        instance={selectedInstance} 
                        logs={logs}
                        clearLogs={() => setLogs([])}
                        onBack={() => { setView('list'); setSelectedInstance(null); }}
                        onUpdate={(action) => deploy(action, selectedInstance.name, selectedInstance.config)}
                    />
                );
            }

            if (view === 'wizard') {
                return (
                    <div className="container mx-auto p-4 max-w-3xl">
                        <div className="mb-6 flex justify-between">
                            <div>
                                <button onClick={() => setView('list')} className="text-slate-400 hover:text-white">&larr; Cancel</button>
                                <h1 className="text-3xl font-bold mt-2">Setup Wizard</h1>
                            </div>
                            <div className="text-slate-500">Step {step} of 4</div>
                        </div>

                        {/* Step 1: GCP Foundation */}
                        {step === 1 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-blue-400">1. Google Cloud Foundation</h2>
                                
                                {!gcpAuth?.authenticated && (
                                    <div className="bg-red-900/30 border border-red-500 p-4 rounded">
                                        <p className="font-bold text-red-200">‚ö†Ô∏è Not Authenticated</p>
                                        <p className="text-sm">Please run this in your terminal:</p>
                                        <code className="block bg-black p-2 mt-2 rounded">gcloud auth login</code>
                                        <button onClick={checkGcp} className="mt-2 btn-secondary text-xs">Refresh Status</button>
                                    </div>
                                )}

                                {gcpAuth?.authenticated && (
                                    <div className="space-y-4">
                                        <div className="bg-green-900/20 p-3 rounded text-green-300 text-sm">
                                            ‚úÖ Authenticated as: {gcpAuth.account}
                                        </div>

                                        {/* Project Selection Tabs */}
                                        <div className="flex border-b border-slate-700">
                                            <button 
                                                className={`px-4 py-2 text-sm ${projectMode === 'select' ? 'text-blue-400 border-b-2 border-blue-400' : 'text-slate-400'}`}
                                                onClick={() => setProjectMode('select')}
                                            >
                                                Select Existing
                                            </button>
                                            <button 
                                                className={`px-4 py-2 text-sm ${projectMode === 'create' ? 'text-blue-400 border-b-2 border-blue-400' : 'text-slate-400'}`}
                                                onClick={() => setProjectMode('create')}
                                            >
                                                Create New
                                            </button>
                                        </div>

                                        {projectMode === 'select' && (
                                            <div>
                                                <label className="block text-sm mb-1">Select Project</label>
                                                <select 
                                                    className="input-field" 
                                                    value={wizProject} 
                                                    onChange={e => setWizProject(e.target.value)}
                                                >
                                                    <option value="">-- Choose a Project --</option>
                                                    {projects.map(p => (
                                                        <option key={p.projectId} value={p.projectId}>{p.name} ({p.projectId})</option>
                                                    ))}
                                                </select>
                                            </div>
                                        )}

                                        {projectMode === 'create' && (
                                            <div className="space-y-3 bg-slate-800 p-4 rounded">
                                                <p className="text-sm text-slate-300">Create a new project for your bot.</p>
                                                
                                                <div>
                                                    <label className="block text-xs text-slate-400 mb-1">New Project ID (Unique)</label>
                                                    <div className="flex gap-2">
                                                        <input 
                                                            className="input-field flex-1" 
                                                            value={newProjectId} 
                                                            onChange={e => setNewProjectId(e.target.value.toLowerCase())} 
                                                            placeholder="my-openclaw-bot-1" 
                                                        />
                                                        <button 
                                                            onClick={createProject} 
                                                            disabled={createLoading || !newProjectId}
                                                            className="btn-primary"
                                                        >
                                                            {createLoading ? 'Creating...' : 'Create'}
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="mt-4 pt-4 border-t border-slate-700">
                                                    <p className="text-xs font-bold text-slate-400 mb-1">OR Create Manually (Recommended for Personal Accounts)</p>
                                                    <ol className="list-decimal pl-4 text-xs text-slate-400 space-y-1">
                                                        <li>Go to <a href="https://console.cloud.google.com/projectcreate" target="_blank" className="text-blue-400 underline">Google Cloud Console &gt; New Project</a>.</li>
                                                        <li>Enter a name and create it.</li>
                                                        <li><b className="text-white">Important:</b> Enable Billing for the project.</li>
                                                        <li>Return here, click "Select Existing", and hit "Refresh Status" above if it doesn't appear.</li>
                                                    </ol>
                                                </div>
                                            </div>
                                        )}

                                        {wizProject && (
                                            <div className="border-t border-slate-700 pt-4">
                                                <div className="flex justify-between items-center mb-2">
                                                    <p className="text-sm font-bold">API Status</p>
                                                    {apiStatus === 'loading' && <span className="text-xs text-slate-500 animate-pulse">Checking...</span>}
                                                </div>
                                                
                                                {apiStatus && apiStatus !== 'loading' && (
                                                    <div className="grid grid-cols-2 gap-2 mb-4">
                                                        <ApiStatusBadge name="Compute Engine" enabled={apiStatus['compute.googleapis.com']} />
                                                        <ApiStatusBadge name="Gmail API" enabled={apiStatus['gmail.googleapis.com']} />
                                                        <ApiStatusBadge name="Calendar API" enabled={apiStatus['calendar.googleapis.com']} />
                                                        <ApiStatusBadge name="Drive API" enabled={apiStatus['drive.googleapis.com']} />
                                                    </div>
                                                )}

                                                <button onClick={enableApis} className="btn-secondary w-full">
                                                    ‚ö° Enable OpenClaw APIs
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                <div className="flex justify-end pt-4">
                                    <button onClick={nextStep} disabled={!wizProject} className={`btn-primary ${!wizProject ? 'opacity-50 cursor-not-allowed' : ''}`}>Next &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Step 2: Bot Identity (OAuth) */}
                        {step === 2 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-purple-400">2. Bot Identity (Email Access)</h2>
                                <p className="text-sm text-slate-400">To let the bot read your email/calendar, you need to create an OAuth Client ID.</p>
                                
                                <div className="bg-slate-800 p-4 rounded text-sm space-y-2">
                                    <p className="font-bold">Instructions:</p>
                                    <ol className="list-decimal pl-4 space-y-1">
                                        <li>Go to <a href={`https://console.cloud.google.com/apis/credentials/consent?project=${wizProject}`} target="_blank" className="text-blue-400 underline">OAuth Consent Screen</a>. Select "External" and fill in required fields. Add yourself as a "Test User".</li>
                                        <li>Go to <a href={`https://console.cloud.google.com/apis/credentials?project=${wizProject}`} target="_blank" className="text-blue-400 underline">Credentials</a>.</li>
                                        <li>Click <b>Create Credentials &gt; OAuth client ID</b>.</li>
                                        <li>Type: <b>Desktop App</b> (or Web Application).</li>
                                        <li>Copy the Client ID and Secret below.</li>
                                    </ol>
                                </div>

                                <div className="grid gap-4">
                                    <div>
                                        <label className="block text-sm mb-1">Client ID</label>
                                        <input className="input-field" value={clientId} onChange={e => setClientId(e.target.value)} placeholder="...apps.googleusercontent.com" />
                                    </div>
                                    <div>
                                        <label className="block text-sm mb-1">Client Secret</label>
                                        <input className="input-field" type="password" value={clientSecret} onChange={e => setClientSecret(e.target.value)} placeholder="GOCSPX-..." />
                                    </div>
                                </div>

                                <div className="flex justify-between pt-4">
                                    <button onClick={prevStep} className="btn-secondary">&larr; Back</button>
                                    <button onClick={nextStep} className="btn-primary">Next &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Step 3: Infrastructure & Security */}
                        {step === 3 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-green-400">3. Infrastructure & Security</h2>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm mb-1">Bot Name</label>
                                        <input className="input-field" value={wizName} onChange={e => setWizName(e.target.value)} placeholder="shodan-v2" />
                                    </div>
                                    <div>
                                        <label className="block text-sm mb-1">Zone</label>
                                        <input className="input-field" value={wizZone} onChange={e => setWizZone(e.target.value)} />
                                    </div>
                                </div>

                                <div className="border-t border-slate-700 pt-4">
                                    <label className="block text-sm mb-1">Tailscale Auth Key (Required)</label>
                                    <input className="input-field" value={wizTailscale} onChange={e => setWizTailscale(e.target.value)} placeholder="tskey-auth-..." />
                                    <p className="text-xs text-slate-500 mt-1">
                                        <a href="https://login.tailscale.com/admin/settings/keys" target="_blank" className="underline text-blue-400">Get Key</a>
                                    </p>
                                </div>

                                <div className="flex justify-between pt-4">
                                    <button onClick={prevStep} className="btn-secondary">&larr; Back</button>
                                    <button onClick={nextStep} disabled={!wizName || !wizTailscale} className={`btn-primary ${(!wizName || !wizTailscale) ? 'opacity-50' : ''}`}>Next &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Step 4: Final Review */}
                        {step === 4 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-white">4. Ready to Deploy?</h2>
                                
                                <div className="bg-slate-800 p-4 rounded text-sm space-y-2">
                                    <p><b>Project:</b> {wizProject}</p>
                                    <p><b>Bot Name:</b> {wizName}</p>
                                    <p><b>Zone:</b> {wizZone}</p>
                                    <p><b>Auth:</b> {clientId ? 'OAuth Configured' : 'No OAuth (Limited Email Access)'}</p>
                                    <p><b>Security:</b> Tailscale Enabled</p>
                                </div>

                                <div className="flex justify-between pt-4">
                                    <button onClick={prevStep} className="btn-secondary">&larr; Back</button>
                                    <button onClick={() => deploy('create')} className="btn-primary bg-green-600 hover:bg-green-700 text-lg px-8">
                                        üöÄ Launch Bot
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        <LogTerminal />
                    </div>
                );
            }

            return (
                <div className="container mx-auto p-8 max-w-5xl">
                    <div className="flex justify-between items-center mb-12">
                        <div>
                            <h1 className="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-600">
                                OpenClaw Control Center
                            </h1>
                            <p className="text-slate-400 mt-2">Manage your autonomous agents</p>
                        </div>
                        <button onClick={startWizard} className="btn-primary text-lg px-6 py-3 shadow-lg shadow-blue-900/20">
                            + New Deployment
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {deployments.map(d => (
                            <div key={d.name} className="card hover:border-slate-600 transition cursor-pointer">
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-xl font-bold">{d.name}</h3>
                                    <span className="bg-green-900 text-green-300 text-xs px-2 py-1 rounded">Active</span>
                                </div>
                                <div className="text-sm text-slate-400 space-y-2">
                                    <p>Zone: {d.config.zone || 'Unknown'}</p>
                                    <p>Project: {d.config.project_id || 'Default'}</p>
                                </div>
                                <div className="mt-6 flex gap-2">
                                    <button 
                                        onClick={() => { setWizName(d.name); setWizProject(d.config.project_id); setWizZone(d.config.zone); setView('logs'); deploy('update'); }}
                                        className="btn-secondary text-sm flex-1"
                                    >
                                        Update
                                    </button>
                                    <button className="btn-secondary text-sm flex-1">Config</button>
                                </div>
                            </div>
                        ))}
                        
                        {deployments.length === 0 && (
                            <div className="col-span-full text-center py-20 border-2 border-dashed border-slate-800 rounded-xl text-slate-500">
                                No deployments found. Start your first agent!
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>