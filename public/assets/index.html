<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .input-field { @apply w-full bg-slate-800 border border-slate-700 rounded p-2 text-white focus:outline-none focus:border-blue-500 transition-colors; }
        .btn-primary { @apply bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-2 px-4 rounded shadow-lg shadow-blue-900/20 transition-all transform hover:scale-[1.02]; }
        .btn-secondary { @apply bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-medium py-2 px-4 rounded transition-all; }
        .btn-danger { @apply bg-red-900/20 hover:bg-red-900/40 border border-red-900 text-red-400 font-medium py-2 px-4 rounded transition-all; }
        .card { @apply bg-slate-900/50 backdrop-blur-sm border border-slate-800 rounded-xl p-6 shadow-xl transition-all hover:border-slate-700; }
        .glass-panel { @apply bg-slate-900/80 backdrop-blur border border-slate-800 rounded-xl shadow-2xl; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (SVGs) ---
        const Icons = {
            Server: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 01-2 2v4a2 2 0 012 2h14a2 2 0 012-2v-4a2 2 0 01-2-2m-2-4h.01M17 16h.01"></path></svg>,
            Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>,
            Cpu: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>,
            Terminal: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>,
            Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>,
            ArrowLeft: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"></path></svg>
        };

        const LogTerminal = ({ logs, clearLogs }) => {
            const bottomRef = useRef(null);
            useEffect(() => {
                bottomRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [logs]);

            if (logs.length === 0) return null;

            return (
                <div className="mt-4 border-t border-slate-700 pt-4">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="text-xs font-bold uppercase tracking-wider text-slate-500 flex items-center gap-2">
                            <Icons.Terminal /> Console Output
                        </h3>
                        <button onClick={clearLogs} className="text-xs text-slate-600 hover:text-slate-400">Clear</button>
                    </div>
                    <div className="bg-black text-green-400 p-4 rounded-lg font-mono text-xs h-48 overflow-y-auto whitespace-pre-wrap border border-slate-800 shadow-inner">
                        {logs.join('')}
                        <div ref={bottomRef} />
                    </div>
                </div>
            );
        };

        // --- Instance Details View ---
        const InstanceDetails = ({ instance, onBack, onUpdate, logs, clearLogs }) => {
            const [activeTab, setActiveTab] = useState('overview');
            const [config, setConfig] = useState(instance.config || {});
            const [unsaved, setUnsaved] = useState(false);

            // Tabs
            const tabs = [
                { id: 'overview', label: 'Overview', icon: Icons.Server },
                { id: 'config', label: 'Configuration', icon: Icons.Settings },
                { id: 'security', label: 'Security', icon: Icons.Shield },
                { id: 'logs', label: 'Logs & Operations', icon: Icons.Terminal },
            ];

            return (
                <div className="container mx-auto p-6 max-w-6xl animate-fade-in">
                    {/* Header */}
                    <div className="flex items-center gap-4 mb-8">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-slate-800 text-slate-400 hover:text-white transition">
                            <Icons.ArrowLeft />
                        </button>
                        <div>
                            <h1 className="text-3xl font-bold text-white">{instance.name}</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]"></span>
                                <span className="text-sm text-green-400 font-medium">Active Deployment</span>
                                <span className="text-slate-600 mx-2">‚Ä¢</span>
                                <span className="text-sm text-slate-400">{config.project_id || 'Unknown Project'}</span>
                                <span className="text-slate-600 mx-2">‚Ä¢</span>
                                <span className="text-sm text-slate-400">{config.zone || 'Unknown Zone'}</span>
                            </div>
                        </div>
                        <div className="ml-auto flex gap-3">
                            <button onClick={() => onUpdate('update')} className="btn-primary flex items-center gap-2">
                                <Icons.Cpu /> Apply Updates
                            </button>
                        </div>
                    </div>

                    <div className="flex gap-8">
                        {/* Sidebar Tabs */}
                        <div className="w-64 flex-shrink-0 space-y-2">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                                        activeTab === tab.id 
                                            ? 'bg-blue-600/10 text-blue-400 border border-blue-600/20' 
                                            : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'
                                    }`}
                                >
                                    <tab.icon />
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 min-w-0">
                            <div className="glass-panel p-6 min-h-[500px]">
                                
                                {activeTab === 'overview' && (
                                    <div className="space-y-6">
                                        <h2 className="text-xl font-bold text-white mb-4">Infrastructure</h2>
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                                <label className="text-xs text-slate-500 uppercase font-bold">Machine Type</label>
                                                <p className="text-lg text-white mt-1">e2-medium (Standard)</p>
                                            </div>
                                            <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                                <label className="text-xs text-slate-500 uppercase font-bold">Disk Size</label>
                                                <p className="text-lg text-white mt-1">50 GB</p>
                                            </div>
                                            <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                                <label className="text-xs text-slate-500 uppercase font-bold">Public Access</label>
                                                <p className="text-lg text-red-400 mt-1 flex items-center gap-2">
                                                    <Icons.Shield /> Blocked (Firewall)
                                                </p>
                                            </div>
                                            <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                                                <label className="text-xs text-slate-500 uppercase font-bold">Private Access</label>
                                                <p className="text-lg text-green-400 mt-1 flex items-center gap-2">
                                                    <span className="w-2 h-2 bg-green-500 rounded-full"></span> Tailscale
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'config' && (
                                    <div className="space-y-6">
                                        <div className="flex justify-between">
                                            <h2 className="text-xl font-bold text-white">Bot Configuration</h2>
                                            <button className="text-sm text-blue-400 hover:text-blue-300">Edit JSON</button>
                                        </div>
                                        <div className="bg-slate-950 p-4 rounded-lg border border-slate-800 font-mono text-sm text-slate-300 overflow-x-auto">
                                            <pre>{JSON.stringify(config, null, 2)}</pre>
                                        </div>
                                        <div className="bg-yellow-900/20 border border-yellow-800 p-4 rounded text-sm text-yellow-500">
                                            ‚ö†Ô∏è Advanced configuration UI coming soon. Edit `clawdbot.json` directly on disk for now.
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'security' && (
                                    <div className="space-y-6">
                                        <h2 className="text-xl font-bold text-white">Security & Access</h2>
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-2">Tailscale Auth Key</label>
                                                <div className="flex gap-2">
                                                    <input 
                                                        className="input-field font-mono text-sm" 
                                                        value={config.tailscale_authkey || ''} 
                                                        readOnly 
                                                        type="password"
                                                    />
                                                    <button className="btn-secondary">Update</button>
                                                </div>
                                                <p className="text-xs text-slate-500 mt-2">
                                                    Updating this key will re-authenticate the bot on the next deployment run.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'logs' && (
                                    <div className="h-full flex flex-col">
                                        <h2 className="text-xl font-bold text-white mb-4">Live Operations</h2>
                                        <div className="flex-1 bg-black rounded-lg border border-slate-800 p-4 overflow-hidden flex flex-col">
                                            <div className="flex-1 overflow-y-auto font-mono text-xs text-green-400 whitespace-pre-wrap">
                                                {logs.length > 0 ? logs.join('') : <span className="text-slate-600">Waiting for logs...</span>}
                                            </div>
                                        </div>
                                        <div className="mt-4 flex gap-2">
                                            <button onClick={clearLogs} className="btn-secondary text-xs">Clear Output</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('list'); // list, wizard, instance
            const [deployments, setDeployments] = useState([]);
            const [logs, setLogs] = useState([]);
            const [selectedInstance, setSelectedInstance] = useState(null);
            
            // Wizard State
            const [step, setStep] = useState(1);
            const [wizName, setWizName] = useState('');
            const [wizProject, setWizProject] = useState('');
            const [wizZone, setWizZone] = useState('us-central1-a'); // Default fallback
            const [wizTailscale, setWizTailscale] = useState('');
            const [wizConfig, setWizConfig] = useState(null);
            
            // GCP State
            const [gcpAuth, setGcpAuth] = useState(null);
            const [projects, setProjects] = useState([]);
            const [projectMode, setProjectMode] = useState('select'); // 'select', 'create'
            const [newProjectId, setNewProjectId] = useState('');
            const [createLoading, setCreateLoading] = useState(false);
            
            // OAuth State
            const [clientId, setClientId] = useState('');
            const [clientSecret, setClientSecret] = useState('');

            // Zone Heuristics
            const detectOptimalZone = () => {
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                if (tz.startsWith('Europe/')) return 'europe-west1-b'; // Belgium
                if (tz.startsWith('Asia/')) return 'asia-northeast1-a'; // Tokyo
                if (tz.startsWith('Australia/')) return 'australia-southeast1-a'; // Sydney
                
                if (tz.startsWith('America/')) {
                    if (tz.includes('New_York') || tz.includes('Toronto') || tz.includes('Detroit')) return 'us-east4-a'; // N. Virginia
                    if (tz.includes('Chicago') || tz.includes('Mexico_City')) return 'us-central1-a'; // Iowa
                    if (tz.includes('Denver') || tz.includes('Phoenix')) return 'us-west4-a'; // Las Vegas
                    if (tz.includes('Los_Angeles') || tz.includes('Vancouver')) return 'us-west1-a'; // Oregon
                    return 'us-east1-b'; // S. Carolina (Safe East default)
                }
                
                return 'us-central1-a'; // Ultimate fallback
            };

            useEffect(() => {
                fetch('/api/deployments').then(r => r.json()).then(setDeployments);
                fetch('/api/template').then(r => r.json()).then(setWizConfig);
                checkGcp();
                
                setWizZone(detectOptimalZone());
                
                const ws = new WebSocket(`ws://${window.location.host}`);
                ws.onmessage = (event) => {
                    setLogs(prev => [...prev, event.data]);
                };
            }, []);

            const checkGcp = () => {
                fetch('/api/gcp/auth').then(r => r.json()).then(setGcpAuth);
                fetch('/api/gcp/projects').then(r => r.json()).then(setProjects);
            };

            const createProject = async () => {
                if (!newProjectId) return;
                setCreateLoading(true);
                try {
                    const res = await fetch('/api/gcp/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectId: newProjectId })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        alert(`Project ${newProjectId} created! Select it from the list.`);
                        setNewProjectId('');
                        setProjectMode('select');
                        checkGcp(); // Refresh list
                    } else {
                        alert(`Error: ${data.error}\n\nTip: You might need to create it manually in the console if you don't have Organization permissions.`);
                    }
                } catch (e) {
                    alert('Failed to create project.');
                } finally {
                    setCreateLoading(false);
                }
            };

            const enableApis = async () => {
                if (!wizProject) return alert('Select a project first');
                await fetch('/api/gcp/services', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId: wizProject })
                });
                alert('API Enablement started. Check logs below for progress.');
            };

            const startWizard = () => {
                setWizName('');
                setStep(1);
                setWizZone(detectOptimalZone());
                setView('wizard');
            };

            const nextStep = () => setStep(s => s + 1);
            const prevStep = () => setStep(s => s - 1);

            const deploy = async (action, instanceName, configOverride) => {
                const targetName = instanceName || wizName;
                
                // If deploying via Wizard, use wizard state
                // If updating via Instance View, use current config
                let body = {};
                
                if (instanceName) {
                    // Update existing
                    body = { 
                        action: action,
                        gcpProject: configOverride?.project_id,
                        gcpZone: configOverride?.zone
                    };
                } else {
                    // New Create
                    const finalConfig = { ...wizConfig };
                    if (clientId) {
                        finalConfig.env.vars.GOOGLE_CLIENT_ID = clientId;
                        finalConfig.env.vars.GOOGLE_CLIENT_SECRET = clientSecret;
                    }
                    
                    // Save config first
                    await fetch(`/api/deployments/${targetName}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tailscaleKey: wizTailscale,
                            gcpProject: wizProject,
                            gcpZone: wizZone,
                            openclawConfig: finalConfig
                        })
                    });
                    
                    body = { 
                        action: action,
                        gcpProject: wizProject,
                        gcpZone: wizZone
                    };
                }

                // Trigger Script
                await fetch(`/api/deploy/${targetName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
            };

            // Main Render
            if (view === 'instance') {
                return (
                    <InstanceDetails 
                        instance={selectedInstance} 
                        logs={logs}
                        clearLogs={() => setLogs([])}
                        onBack={() => { setView('list'); setSelectedInstance(null); }}
                        onUpdate={(action) => deploy(action, selectedInstance.name, selectedInstance.config)}
                    />
                );
            }

            if (view === 'wizard') {
                return (
                    <div className="container mx-auto p-4 max-w-3xl animate-fade-in">
                        <div className="mb-6 flex justify-between">
                            <div>
                                <button onClick={() => setView('list')} className="text-slate-400 hover:text-white flex items-center gap-1 transition">
                                    <Icons.ArrowLeft /> Cancel
                                </button>
                                <h1 className="text-3xl font-bold mt-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">Setup Wizard</h1>
                            </div>
                            <div className="text-slate-500 font-mono text-sm py-2">Step {step} of 4</div>
                        </div>

                        {/* Step 1: GCP Foundation */}
                        {step === 1 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-blue-400 flex items-center gap-2">
                                    <span className="w-6 h-6 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-xs border border-blue-500/50">1</span>
                                    Google Cloud Foundation
                                </h2>
                                
                                {!gcpAuth?.authenticated && (
                                    <div className="bg-red-900/20 border border-red-500/50 p-4 rounded-lg">
                                        <p className="font-bold text-red-200">‚ö†Ô∏è Not Authenticated</p>
                                        <p className="text-sm text-red-300/80 mt-1">Please run this in your terminal to connect:</p>
                                        <code className="block bg-black/50 p-3 mt-2 rounded border border-red-900/50 font-mono text-sm">gcloud auth login</code>
                                        <button onClick={checkGcp} className="mt-3 btn-secondary text-xs">Refresh Status</button>
                                    </div>
                                )}

                                {gcpAuth?.authenticated && (
                                    <div className="space-y-6">
                                        <div className="bg-emerald-900/20 border border-emerald-500/30 p-3 rounded-lg text-emerald-300 text-sm flex items-center gap-2">
                                            <span>‚úÖ</span> Authenticated as: <span className="font-bold">{gcpAuth.account}</span>
                                        </div>

                                        {/* Project Selection Tabs */}
                                        <div>
                                            <div className="flex border-b border-slate-700 mb-4">
                                                <button 
                                                    className={`px-4 py-2 text-sm font-medium transition-colors ${projectMode === 'select' ? 'text-blue-400 border-b-2 border-blue-400' : 'text-slate-400 hover:text-slate-200'}`}
                                                    onClick={() => setProjectMode('select')}
                                                >
                                                    Select Existing
                                                </button>
                                                <button 
                                                    className={`px-4 py-2 text-sm font-medium transition-colors ${projectMode === 'create' ? 'text-blue-400 border-b-2 border-blue-400' : 'text-slate-400 hover:text-slate-200'}`}
                                                    onClick={() => setProjectMode('create')}
                                                >
                                                    Create New
                                                </button>
                                            </div>

                                            {projectMode === 'select' && (
                                                <div>
                                                    <label className="block text-sm font-medium mb-2 text-slate-300">Google Cloud Project</label>
                                                    <select 
                                                        className="input-field" 
                                                        value={wizProject} 
                                                        onChange={e => setWizProject(e.target.value)}
                                                    >
                                                        <option value="">-- Choose a Project --</option>
                                                        {projects.map(p => (
                                                            <option key={p.projectId} value={p.projectId}>{p.name} ({p.projectId})</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}

                                            {projectMode === 'create' && (
                                                <div className="space-y-4 bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">New Project ID (Unique)</label>
                                                        <div className="flex gap-2">
                                                            <input 
                                                                className="input-field flex-1" 
                                                                value={newProjectId} 
                                                                onChange={e => setNewProjectId(e.target.value.toLowerCase())} 
                                                                placeholder="my-openclaw-bot-1" 
                                                            />
                                                            <button 
                                                                onClick={createProject} 
                                                                disabled={createLoading || !newProjectId}
                                                                className="btn-primary py-1"
                                                            >
                                                                {createLoading ? 'Creating...' : 'Create'}
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <div className="pt-4 border-t border-slate-700/50">
                                                        <p className="text-xs font-bold text-slate-400 mb-2">OR Create Manually (Recommended)</p>
                                                        <ol className="list-decimal pl-4 text-xs text-slate-400 space-y-1.5 marker:text-slate-600">
                                                            <li>Go to <a href="https://console.cloud.google.com/projectcreate" target="_blank" className="text-blue-400 hover:text-blue-300 underline">Google Cloud Console > New Project</a>.</li>
                                                            <li>Enter a name and create it.</li>
                                                            <li><b className="text-slate-200">Important:</b> Enable Billing for the project.</li>
                                                            <li>Return here, click "Select Existing", and hit "Refresh Status" above.</li>
                                                        </ol>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {wizProject && (
                                            <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                                                <p className="text-sm mb-3 text-slate-300">Ensure required APIs (Gmail, Compute, etc.) are enabled.</p>
                                                <button onClick={enableApis} className="btn-secondary w-full border-blue-500/30 hover:border-blue-500/50 text-blue-300">
                                                    ‚ö° Enable OpenClaw APIs
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                <div className="flex justify-end pt-4">
                                    <button onClick={nextStep} disabled={!wizProject} className={`btn-primary ${!wizProject ? 'opacity-50 cursor-not-allowed' : ''}`}>Next &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Step 2: Bot Identity (OAuth) */}
                        {step === 2 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-purple-400 flex items-center gap-2">
                                    <span className="w-6 h-6 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center text-xs border border-purple-500/50">2</span>
                                    Bot Identity (Access & Permissions)
                                </h2>
                                <p className="text-sm text-slate-300">
                                    Just like you log in to Google, your bot needs its own credentials to securely access services like Gmail and Calendar on your behalf.
                                </p>
                                
                                <div className="bg-slate-800/50 p-5 rounded-lg text-sm space-y-3 border border-slate-700">
                                    <p className="font-bold text-white">How to get your Client ID & Secret:</p>
                                    <ol className="list-decimal pl-4 space-y-2 text-slate-300 marker:text-slate-500">
                                        <li>
                                            Go to the <a href={`https://console.cloud.google.com/apis/credentials/consent?project=${wizProject}`} target="_blank" className="text-blue-400 underline hover:text-blue-300">OAuth Consent Screen</a>.
                                            <ul className="list-disc pl-4 mt-1 text-slate-400 text-xs space-y-1">
                                                <li>Select <b>External</b> (for personal use) and click Create.</li>
                                                <li>Fill in the App Name (e.g., "My Bot") and your email.</li>
                                                <li>Important: Add yourself as a <b>Test User</b>.</li>
                                            </ul>
                                        </li>
                                        <li>
                                            Go to <a href={`https://console.cloud.google.com/apis/credentials?project=${wizProject}`} target="_blank" className="text-blue-400 underline hover:text-blue-300">Credentials</a>.
                                        </li>
                                        <li>Click <b>+ Create Credentials</b> &gt; <b>OAuth client ID</b>.</li>
                                        <li>Application Type: Choose <b>Desktop App</b> (or Web App).</li>
                                        <li>Copy the generated <b>Client ID</b> and <b>Client Secret</b> below.</li>
                                    </ol>
                                </div>

                                <div className="grid gap-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-slate-300">Client ID</label>
                                        <input className="input-field" value={clientId} onChange={e => setClientId(e.target.value)} placeholder="...apps.googleusercontent.com" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-slate-300">Client Secret</label>
                                        <input className="input-field" type="password" value={clientSecret} onChange={e => setClientSecret(e.target.value)} placeholder="GOCSPX-..." />
                                    </div>
                                </div>

                                <div className="flex justify-between pt-4">
                                    <button onClick={prevStep} className="btn-secondary">&larr; Back</button>
                                    <button onClick={nextStep} className="btn-primary">Next &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Step 3: Infrastructure & Security */}
                        {step === 3 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-green-400 flex items-center gap-2">
                                    <span className="w-6 h-6 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-xs border border-green-500/50">3</span>
                                    Server & Security
                                </h2>
                                
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-slate-300">Bot Name</label>
                                        <input className="input-field" value={wizName} onChange={e => setWizName(e.target.value)} placeholder="my-assistant-bot" />
                                        <p className="text-xs text-slate-500 mt-1">A unique label for your server.</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-slate-300">Location (Zone)</label>
                                        <input className="input-field" value={wizZone} onChange={e => setWizZone(e.target.value)} />
                                        <p className="text-xs text-slate-500 mt-1">Physical data center location.</p>
                                    </div>
                                </div>

                                <div className="border-t border-slate-700/50 pt-6">
                                    <h3 className="font-bold text-white mb-2 flex items-center gap-2"><Icons.Shield /> Private Network Access (Tailscale)</h3>
                                    <p className="text-sm text-slate-400 mb-4">
                                        We use <a href="https://tailscale.com" target="_blank" className="text-blue-400 hover:underline">Tailscale</a> to create a secure, private tunnel to your bot. This ensures <b>only you</b> can access it, even though it's on the cloud.
                                    </p>
                                    
                                    <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                        <label className="block text-sm font-medium mb-1 text-slate-300">Tailscale Auth Key (Required)</label>
                                        <input className="input-field font-mono text-sm" value={wizTailscale} onChange={e => setWizTailscale(e.target.value)} placeholder="tskey-auth-..." />
                                        <div className="flex justify-between items-center mt-3">
                                            <p className="text-xs text-slate-500">
                                                Think of this as a one-time invitation code for your bot.
                                            </p>
                                            <a href="https://login.tailscale.com/admin/settings/keys" target="_blank" className="text-xs btn-secondary py-1 px-3 bg-slate-700 hover:bg-slate-600">
                                                Generate Key &rarr;
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-between pt-4">
                                    <button onClick={prevStep} className="btn-secondary">&larr; Back</button>
                                    <button onClick={nextStep} disabled={!wizName || !wizTailscale} className={`btn-primary ${(!wizName || !wizTailscale) ? 'opacity-50' : ''}`}>Next &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Step 4: Final Review */}
                        {step === 4 && (
                            <div className="card space-y-6">
                                <h2 className="text-xl font-semibold text-white flex items-center gap-2">
                                    <span className="w-6 h-6 rounded-full bg-slate-500/20 text-slate-400 flex items-center justify-center text-xs border border-slate-500/50">4</span>
                                    Ready to Launch?
                                </h2>
                                <p className="text-sm text-slate-400">Review your configuration before we start the deployment.</p>
                                
                                <div className="bg-slate-800/80 p-6 rounded-xl text-sm space-y-3 border border-slate-700 shadow-inner">
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Project:</span>
                                        <span className="font-mono text-white font-medium">{wizProject}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Bot Name:</span>
                                        <span className="font-mono text-white font-medium">{wizName}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Location:</span>
                                        <span className="font-mono text-white font-medium">{wizZone}</span>
                                    </div>
                                    <div className="border-t border-slate-700/50 my-2"></div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Identity:</span>
                                        <span className={clientId ? "text-emerald-400 font-medium" : "text-yellow-500 font-medium"}>
                                            {clientId ? '‚úÖ OAuth Configured' : '‚ö†Ô∏è No OAuth (Limited Access)'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Security:</span>
                                        <span className="text-emerald-400 font-medium">‚úÖ Tailscale Enabled</span>
                                    </div>
                                </div>

                                <div className="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-lg text-xs text-indigo-200">
                                    <p className="font-bold text-indigo-300 mb-2">üöÄ What happens next:</p>
                                    <ul className="list-disc pl-4 space-y-1.5 opacity-80">
                                        <li>A virtual machine will be created in your Google Cloud project.</li>
                                        <li>OpenClaw will be installed and secured behind the firewall.</li>
                                        <li>The bot will join your Tailscale network.</li>
                                        <li>The process takes about 5-10 minutes. Watch the logs below!</li>
                                    </ul>
                                </div>

                                <div className="flex justify-between pt-4">
                                    <button onClick={prevStep} className="btn-secondary">&larr; Back</button>
                                    <button onClick={() => { setView('instance'); deploy('create', wizName); }} className="btn-primary bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-lg px-8 py-3 shadow-lg shadow-green-900/30">
                                        Launch {wizName}
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        <LogTerminal logs={logs} clearLogs={() => setLogs([])} />
                    </div>
                );
            }

            // Dashboard / List View
            return (
                <div className="container mx-auto p-8 max-w-6xl animate-fade-in">
                    <div className="flex justify-between items-center mb-12">
                        <div>
                            <h1 className="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-indigo-500 tracking-tight">
                                OpenClaw Control Center
                            </h1>
                            <p className="text-slate-400 mt-2 font-light">Manage your autonomous agent fleet</p>
                        </div>
                        <button onClick={startWizard} className="btn-primary text-lg px-6 py-3 flex items-center gap-2">
                            <Icons.Plus /> New Deployment
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {deployments.map(d => (
                            <div 
                                key={d.name} 
                                onClick={() => { setSelectedInstance(d); setView('instance'); }}
                                className="card group cursor-pointer hover:-translate-y-1 transition-all duration-300 border-t-4 border-t-transparent hover:border-t-blue-500 relative overflow-hidden"
                            >
                                <div className="absolute top-0 right-0 p-4 opacity-50 group-hover:opacity-100 transition-opacity">
                                    <Icons.Server />
                                </div>
                                
                                <div className="flex justify-between items-start mb-4 relative z-10">
                                    <div>
                                        <h3 className="text-xl font-bold text-white group-hover:text-blue-400 transition-colors">{d.name}</h3>
                                        <p className="text-xs text-slate-500 mt-1 uppercase tracking-wider font-bold">{d.config.project_id || 'Unknown Project'}</p>
                                    </div>
                                    <span className="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 text-xs px-2 py-1 rounded-full font-medium shadow-[0_0_10px_rgba(16,185,129,0.1)]">
                                        Active
                                    </span>
                                </div>
                                
                                <div className="text-sm text-slate-400 space-y-3 mt-6 border-t border-slate-800/50 pt-4">
                                    <div className="flex items-center gap-2">
                                        <span className="w-2 h-2 bg-slate-600 rounded-full"></span>
                                        {d.config.zone || 'Unknown Zone'}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_5px_rgba(34,197,94,0.5)]"></span>
                                        Tailscale Enabled
                                    </div>
                                </div>
                            </div>
                        ))}
                        
                        {deployments.length === 0 && (
                            <div className="col-span-full py-24 border-2 border-dashed border-slate-800 rounded-2xl text-center">
                                <div className="inline-flex p-4 rounded-full bg-slate-900 mb-4">
                                    <Icons.Server />
                                </div>
                                <h3 className="text-xl font-bold text-slate-300">No agents deployed</h3>
                                <p className="text-slate-500 mt-2 max-w-md mx-auto">Get started by launching your first OpenClaw instance using the wizard above.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
